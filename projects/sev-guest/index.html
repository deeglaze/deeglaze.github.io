<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> go-sev-guest | Dionna Amalie Glaze </title> <meta name="author" content="Dionna Amalie Glaze"> <meta name="description" content="Client and server logic for AMD SEV-SNP attestations"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://deeglaze.github.io/projects/sev-guest/"> <script src="/assets/js/theme.js?0ae19fbbb9d07170fc2bd07826031ef0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Dionna</span> Amalie Glaze </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item active"> <a class="nav-link" href="/projects/">projects <span class="sr-only">(current)</span> </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">go-sev-guest</h1> <p class="post-description">Client and server logic for AMD SEV-SNP attestations</p> </header> <article> <p>I’m the primary author of the <a href="https://github.com/google/go-sev-guest" rel="external nofollow noopener" target="_blank">go-sev-guest</a> project. When AMD contributed the /dev/sev-guest driver to Linux, it was based on ioctls. To test Google Compute Engine’s support for attestation quality of service controls (anti-DoS) and partner distributions’ support for remote attestation, we needed an easy way to collect an attestation report. From that need came the initial <code class="language-plaintext highlighter-rouge">client</code> library. To get good unit testing support, I ended up writing a simulator for attestation report signing. Things kind of snowballed from there.</p> <h2 id="feature-history">Feature history</h2> <p>After we found that attestations were able to be collected, we needed a way to check that they meet the basic requirements of the platform. That is, we needed to check the signatures rooted back to AMD in the way we expected. Then we wanted to check that other aspects of the report matched some expectations. These latter two needs are less “guest” responsibility and more “server”, so the repo is named weirdly, but it’s all being implemented over and over by different projects like Confidential Containers, VirTEE, cc-trusted-api, and probably PARSEC soon enough. We’re all making our own message formats and policy logic, but eventually, if we do it right, the IETF standards will make it so everyone converges on the same formats for attestation report and reference value interchange.</p> <p>An adjacent team had been developing the infrastructure needed to provision machine-specific certificates for verifying attestation reports. They weren’t deployed yet though, so I needed to manually provision the certificates for all our test machines every time there was a host firmware upgrade (which changes the <code class="language-plaintext highlighter-rouge">TCB_VERSION</code>). I just threw everything into a protocol buffer that I checked into version control and looked up expected certificates by the machine’s hostname. So far so good. But then, trouble hit.</p> <h2 id="certificate-storytime">Certificate storytime</h2> <p>AMD published a specification for their Key Distribution Service (KDS), which allows you to fetch the VCEK certificate given a <code class="language-plaintext highlighter-rouge">CHIP_ID</code>, the <code class="language-plaintext highlighter-rouge">TCB_VERSION</code> it’s versioned against, and which model of chip it is. I then made sure that certificates from AMD matched their specification down to every detail of metadata and x.509 certificate extension. There’s a problem with this however. The <code class="language-plaintext highlighter-rouge">productName</code> extension uses a name that is assigned outside the system specification. There’s a “family/model/stepping” (FMS) triple of numbers that <code class="language-plaintext highlighter-rouge">CPUID[1]_EAX</code> reports that allows you to determine which chip version you’re running. The FMS corresponds to a product name according to the phase of development their change to stepping has caused, with some letter assignment something-or-other. You thus have to hardcode a table of “x,y,0 means Product-B0”, “x,y,1 means Product-E0”, “x,y,2 means Product-E1” etc. We then got the next version of the hardware. Machines were now Milan-B1 instead of Milan-B0. Something weird happened, though. We updated the CPUID table to report the correct stepping value for the hardware, but the certificates no longer matched expectations. The new stepping value was hardcoded to mean “Milan-B1”, but the KDS-delivered <code class="language-plaintext highlighter-rouge">productName</code> was still “Milan-B0”. After some communication with AMD, we learned that the <code class="language-plaintext highlighter-rouge">productName</code> got assigned at the wrong time during AMD’s manufacturing process. The <code class="language-plaintext highlighter-rouge">productName</code> was assigned according to the IO chip’s FMS, and not the core compute chip’s FMS, so we couldn’t trust the extension. As of June 2024, that’s still the case with KDS. The go-sev-guest verification library requires a workaround flag to not cross-reference the productName with the CPUID. Given that the FMS for the attestation-collector wasn’t collected into the report itself, I needed to make the client add that information to the message it created to represent the attestation report. AMD says that need will go away in the future, since they’re going to update the firmware to include the FMS in the report to not need extra information that the report itself to fetch the correct VCEK certificate.</p> <h2 id="security-storytime">Security storytime</h2> <p>The AMD Security Processor (AMD-SP) is the rebranded name of the AMD Platform Security Processor (PSP). The PSP is a small ARM chip in the EPYC package that is a bottleneck for measuring AMD SEV-SNP VM launches and for signing attestation reports. The host kernel has to manage guest requests from VMs to the chip through serialized locking, so it’s possible for one customer to affect another’s ability to get an attestation report unless we throttle the requests. The AMD system programming manual also says as much. The guest driver did not respond correctly to being throttled, however.</p> <p>It was possible to have a guest reuse its Galois counter in the encryption on messages getting sent to the PSP. The PSP maintains its own monotonic counter, and the guest needs to maintain the same counter. If the counters are ever out of sequence, the protocol may be under attack. A failure from throttling would mean the message did not reach the PSP, so the guest should not increment its counter. The driver did not protect itself from using the same counter on different messages, so a concurrent request from user space for an attestation report could cause a communication key (VMPCK0) to leak from simple cryptanalysis. The solution had some nuances.</p> <ol> <li>The encryption was happening on an unencrypted page. Intermediate results of computing the encrypted message allow for information to leak. The solution is to encrypt on an encrypted temporary buffer and only copy the result to the unencrypted page for the VMM to pass along to the PSP. I found that the Coconut-SVSM attestation report logic had the same vulnerability when it was in PR review, so 2 crypto bugs found at the price of one.</li> <li>Failure from the host could lead to counter skew between the PSP and guest, so instead of blithely reusing the same counter after returning a failure to user space, the driver would have to fail closed. To avoid key leaks, a host failure now drives the response that the communication key gets destroyed and any other attempt to use it returns <code class="language-plaintext highlighter-rouge">-ENOTTY</code>. Thanks to my team’s tech lead Peter Gonda for finding this when reviewing my throttling fix.</li> <li>Failure from the host due to throttling should lead to backoff and retry without returning to user space, and without destroying the communication key. The retry is safe in the throttling case because the message is always the same. I convinced AMD to update their GHCB protocol specification to allow for a “good faith” VMM error code to work with the guest. The guest can use this code to retry sending a request after some time before failing with a timeout. Since throttling is an expected host response, this allows the guest to make progress given the new key destruction behavior.</li> <li>The VMM error code is stored in the upper 32 bits of the host return value, whereas the lower 32 bits are reserved for the firmware error code. The kernel had some type mismatch (<code class="language-plaintext highlighter-rouge">int</code> instead of <code class="language-plaintext highlighter-rouge">__u64</code>) in its response encoding, and it was returning uninitialized stack memory in some cases. The error code piece needed updating in the GHCB specification, and the uninitialized memory bug led to some extra go-sev-guest workaround code.</li> </ol> <h2 id="influence-and-application">Influence and application</h2> <p>The go-sev-guest library design is what our Confidential Computing India team has used as a template for their <a href="https://github.com/google/go-tdx-guest" rel="external nofollow noopener" target="_blank">go-tdx-guest</a> implementation of the analogous Intel technology stack. Both libraries are used in <a href="https://github.com/google/go-tpm-tools" rel="external nofollow noopener" target="_blank">go-tpm-tools</a> as the lead attestation package for Google Compute Engine (GCE) virtual machines.</p> <p>I wrote go-sev-guest to be independent of GCE so it could be used more broadly. Indeed many issues opened on it have been from folks working in AWS or Oracle. Oracle has been testing Genoa machines (the product after Milan) and found that <code class="language-plaintext highlighter-rouge">productName</code> in the VCEK certificates doesn’t even reference the stepping value. Similarly, the VLEK does not reference the stepping value. The security posture of the signing key with respect to its <code class="language-plaintext highlighter-rouge">TCB_VERSION</code> is all relative to the productName, so it pays to test the nittiest of gritty details in cryptographic systems.</p> <p>The GCE-dependent logic that can fuse with the go-sev-guest APIs is implemented in the <code class="language-plaintext highlighter-rouge">gce-tcb-verifier</code> project.</p> </article> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Dionna Amalie Glaze. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?64650b4ca1545a51af0b101f735007ab"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.min.js" integrity="sha256-rjmgmaB99riUNcdlrDtcAiwtLIojSxNyUFdl+Qh+rB4=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>addBackToTop();</script> <script type="module" src="/assets/js/search/ninja-keys.min.js?601a2d3465e2a52bec38b600518d5f70"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script>let theme=determineComputedTheme();const ninjaKeys=document.querySelector("ninja-keys");"dark"===theme?ninjaKeys.classList.add("dark"):ninjaKeys.classList.remove("dark");const openSearchModal=()=>{const e=$("#navbarNav");e.hasClass("show")&&e.collapse("hide"),ninjaKeys.open()};</script> <script>const ninja=document.querySelector("ninja-keys");ninja.data=[{id:"nav-about",title:"about",section:"Navigation",handler:()=>{window.location.href="/"}},{id:"nav-blog",title:"blog",description:"",section:"Navigation",handler:()=>{window.location.href="/blog/"}},{id:"nav-publications",title:"publications",description:"publications by categories in reversed chronological order. generated by jekyll-scholar.",section:"Navigation",handler:()=>{window.location.href="/publications/"}},{id:"nav-projects",title:"projects",description:"Personal and professional projects.",section:"Navigation",handler:()=>{window.location.href="/projects/"}},{id:"nav-repositories",title:"repositories",description:"Edit the `_data/repositories.yml` and change the `github_users` and `github_repos` lists to include your own GitHub profile and repositories.",section:"Navigation",handler:()=>{window.location.href="/repositories/"}},{id:"nav-cv",title:"cv",description:"This is a description of the page. You can modify it in &#39;_pages/cv.md&#39;. You can also change or remove the top pdf download button.",section:"Navigation",handler:()=>{window.location.href="/cv/"}},{id:"post-move-fast-make-shit",title:"Move fast, make shit",description:"",section:"Posts",handler:()=>{window.location.href="/blog/2025/Standards/"}},{id:"post-mentoring-a-swe-part-0",title:"Mentoring a SWE: Part 0",description:"",section:"Posts",handler:()=>{window.location.href="/blog/2024/Mentoring-a-SWE-Part-0/"}},{id:"post-blogging-again",title:"Blogging again",description:"",section:"Posts",handler:()=>{window.location.href="/blog/2024/blogging-again/"}},{id:"posts-blogging-again",title:"Blogging again",description:"",section:"Posts",handler:()=>{window.location.href="/blog/2024/blogging-again/"}},{id:"posts-mentoring-a-swe-part-0",title:"Mentoring a SWE: Part 0",description:"",section:"Posts",handler:()=>{window.location.href="/blog/2024/Mentoring-a-SWE-Part-0/"}},{id:"posts-move-fast-make-shit",title:"Move fast, make shit",description:"",section:"Posts",handler:()=>{window.location.href="/blog/2025/Standards/"}},{id:"projects-gce-tcb-verifier",title:"gce-tcb-verifier",description:"Open Virtual Machine Firmware code signing for SEV-SNP and TDX on Google Compute Engine",section:"Projects",handler:()=>{window.location.href="/projects/gce-tcb-verifier/"}},{id:"projects-go-sev-guest",title:"go-sev-guest",description:"Client and server logic for AMD SEV-SNP attestations",section:"Projects",handler:()=>{window.location.href="/projects/sev-guest/"}},{id:"socials-email",title:"Send email",section:"Socials",handler:()=>{window.open("mailto:%64%72%64%65%65%67%6C%61%7A%65@%67%6D%61%69%6C.%63%6F%6D","_blank")}},{id:"socials-github",title:"GitHub",section:"Socials",handler:()=>{window.open("https://github.com/deeglaze","_blank")}},{id:"socials-mastodon",title:"Mastodon",section:"Socials",handler:()=>{window.open("https://tech.lgbt/@drdeeglaze","_blank")}},{id:"socials-rss",title:"RSS Feed",section:"Socials",handler:()=>{window.open("/feed.xml","_blank")}},{id:"light-theme",title:"Change theme to light",description:"Change the theme of the site to Light",section:"Theme",handler:()=>{setThemeSetting("light")}},{id:"dark-theme",title:"Change theme to dark",description:"Change the theme of the site to Dark",section:"Theme",handler:()=>{setThemeSetting("dark")}},{id:"system-theme",title:"Use system default theme",description:"Change the theme of the site to System Default",section:"Theme",handler:()=>{setThemeSetting("system")}}];</script> <script src="/assets/js/shortcut-key.js"></script> </body> </html>